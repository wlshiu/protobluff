



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="A modular Protocol Buffers implementation for C">
      
      
        <link rel="canonical" href="https://squidfunk.github.io/protobluff/guide/repeated-fields/">
      
      
        <meta name="author" content="Martin Donath">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.1">
    
    
      
        <title>Repeated fields - protobluff</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.a315b664.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.792431c1.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#overview" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://squidfunk.github.io/protobluff/" title="protobluff" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                protobluff
              </span>
              <span class="md-header-nav__topic">
                Repeated fields
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/squidfunk/protobluff" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      squidfunk/protobluff
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="About" class="md-tabs__link">
        About
      </a>
    
  </li>

      
        
      
        
      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../runtimes/" title="Developer guide" class="md-tabs__link md-tabs__link--active">
          Developer guide
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    protobluff
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/squidfunk/protobluff" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      squidfunk/protobluff
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="About" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../getting-started/" title="Getting started" class="md-nav__link">
      Getting started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design-rationale/" title="Design rationale" class="md-nav__link">
      Design rationale
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../similar-projects/" title="Similar projects" class="md-nav__link">
      Similar projects
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Developer guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Developer guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../runtimes/" title="Choosing a runtime" class="md-nav__link">
      Choosing a runtime
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../buffers-and-journals/" title="Buffers and journals" class="md-nav__link">
      Buffers and journals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../messages/" title="Working with messages" class="md-nav__link">
      Working with messages
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../scalar-types/" title="Scalar types" class="md-nav__link">
      Scalar types
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Repeated fields
      </label>
    
    <a href="./" title="Repeated fields" class="md-nav__link md-nav__link--active">
      Repeated fields
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-cursor" title="Creating a cursor" class="md-nav__link">
    Creating a cursor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-a-cursor" title="Working with a cursor" class="md-nav__link">
    Working with a cursor
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#submessages" title="Submessages" class="md-nav__link">
    Submessages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalar-types" title="Scalar types" class="md-nav__link">
    Scalar types
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#freeing-a-cursor" title="Freeing a cursor" class="md-nav__link">
    Freeing a cursor
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../error-handling/" title="Error handling" class="md-nav__link">
      Error handling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../allocators/" title="Custom allocators" class="md-nav__link">
      Custom allocators
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../miscellaneous/" title="Miscellaneous" class="md-nav__link">
      Miscellaneous
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-cursor" title="Creating a cursor" class="md-nav__link">
    Creating a cursor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-a-cursor" title="Working with a cursor" class="md-nav__link">
    Working with a cursor
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#submessages" title="Submessages" class="md-nav__link">
    Submessages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalar-types" title="Scalar types" class="md-nav__link">
    Scalar types
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#freeing-a-cursor" title="Freeing a cursor" class="md-nav__link">
    Freeing a cursor
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Repeated fields</h1>
                
                <h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>protobluff implements the concept of a cursor to access separate instances of a
repeated field within an encoded message. Cursors are capable of handling
tag/value-encoded fields, as well as packed fields very well.</p>
<p>The following explanations on handling repeated fields are based on the example
message type defined in the section on
<a href="../../guide/messages/#defining-a-message-type">working with messages</a>.</p>
<h2 id="creating-a-cursor">Creating a cursor<a class="headerlink" href="#creating-a-cursor" title="Permanent link">&para;</a></h2>
<p>A cursor over a message for a repeated field can be created as follows:</p>
<div class="codehilite"><pre><span></span><span class="n">pb_cursor_t</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">person_create_phone_cursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">person</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pb_cursor_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">))</span>
  <span class="cm">/* Error creating cursor on phone numbers */</span>
<span class="p">}</span>
</pre></div>

<p>The cursor will always either point to a valid instance of a repeated field or
be invalid. If the cursor isn't valid, the cursor may either have encountered
garbled data or there is no instance for the repeated field.</p>
<h2 id="working-with-a-cursor">Working with a cursor<a class="headerlink" href="#working-with-a-cursor" title="Permanent link">&para;</a></h2>
<p>After checking if the cursor is valid, the current field may be read, written
or erased. While scalar types may be directly read and written through the
cursor, submessages must be created from the cursor in order to work with them.
Erasing a field is independent of its type.</p>
<h3 id="submessages">Submessages<a class="headerlink" href="#submessages" title="Permanent link">&para;</a></h3>
<p>Submessages must be created through the function <code>pb_message_create_from_cursor</code>
which will return a message of type <code>pb_message_t</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">pb_cursor_t</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">person_create_phone_cursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">person</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pb_cursor_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="n">pb_message_t</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">pb_message_create_from_cursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pb_message_valid</span><span class="p">())</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">person_phonenumber_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phone</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pb_cursor_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>

<p>The fields of the message can then be normally accessed as described in the
section on <a href="../../guide/messages/">working with messages</a>. After working with the
message, it must be explicitly destroyed.</p>
<h3 id="scalar-types">Scalar types<a class="headerlink" href="#scalar-types" title="Permanent link">&para;</a></h3>
<p>Scalar types may be accessed through the functions <code>pb_cursor_get</code>,
<code>pb_cursor_put</code> and <code>pb_cursor_erase</code>, like in the following example:</p>
<div class="codehilite"><pre><span></span><span class="n">pb_cursor_t</span> <span class="n">cursor</span> <span class="o">=</span> <span class="p">...</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pb_cursor_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">pb_error_t</span> <span class="n">error</span> <span class="o">=</span> <span class="n">PB_ERROR_NONE</span><span class="p">;</span>

  <span class="cm">/* Iterate instances of repeated field */</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">=</span> <span class="n">pb_cursor_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)))</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="cm">/* Erase value if equal to 0 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">error</span> <span class="o">=</span> <span class="n">pb_cursor_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">);</span>

    <span class="cm">/* Otherwise decrement value */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    
      <span class="n">value</span><span class="o">--</span><span class="p">;</span>
      <span class="n">error</span> <span class="o">=</span> <span class="n">pb_cursor_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">pb_cursor_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>

<h2 id="freeing-a-cursor">Freeing a cursor<a class="headerlink" href="#freeing-a-cursor" title="Permanent link">&para;</a></h2>
<p>Like messages, cursors should always be explicitly destroyed to be
future-proof:</p>
<div class="codehilite"><pre><span></span><span class="n">pb_cursor_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor</span><span class="p">);</span>
</pre></div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../scalar-types/" title="Scalar types" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Scalar types
              </span>
            </div>
          </a>
        
        
          <a href="../error-handling/" title="Error handling" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Error handling
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2013 - 2016 Martin Donath
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="http://struct.cc" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/squidfunk" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://twitter.com/squidfunk" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/in/squidfunk" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.9fb73e57.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>